Description: Allow reducing size of xorriso-created rescue images
 This lets us create smaller images that will fit on floppy disks.  It has
 been approved by the upstream maintainer but has not yet been applied.
Author: Thomas Schmitt <scdbackup@gmx.net>
Origin: other, http://lists.gnu.org/archive/html/grub-devel/2010-05/msg00100.html
Forwarded: yes
Last-Update: 2013-11-15

Index: b/util/grub-mkrescue.in
===================================================================
--- a/util/grub-mkrescue.in
+++ b/util/grub-mkrescue.in
@@ -43,6 +43,7 @@
 product_version="${PACKAGE_VERSION}"
 
 xorriso=xorriso
+diet=no
 
 # Usage: usage
 # Print the usage.
@@ -67,6 +68,7 @@
     print_option_help "--product-version=$(gettext "STRING")" "$(gettext "use STRING as product version")"
     print_option_help "--sparc-boot" "$(gettext "enable sparc boot. Disables HFS+, APM, ARCS and boot as disk image for i386-pc")"
     print_option_help "--arcs-boot" "$(gettext "enable ARCS (big-endian mips machines, mostly SGI) boot. Disables HFS+, APM, sparc64 and boot as disk image for i386-pc")"
+    print_option_help "--diet" "$(gettext "apply size reducing measures [optional]")"
     echo
     gettext_printf "%s generates a bootable rescue image with specified source files, source directories, or mkisofs options listed by the output of \`%s'\n" "xorriso -as mkisofs -help" "$self" | grub_fmt
     echo
@@ -158,6 +160,9 @@
     --xorriso=*)
         xorriso=`echo "${option}" | sed 's/--xorriso=//'` ;;
 
+    --diet)
+	diet=yes ;;
+
     *)
 	source="${source} ${option} $@"; break ;;
     esac
@@ -485,7 +490,14 @@
 fi
 
 # build iso image
-"${xorriso}" -as mkisofs -graft-points ${grub_mkisofs_arguments} --protective-msdos-label -o "${output_image}" -r "${iso9660_dir}" --sort-weight 0 / --sort-weight 1 /boot ${source}
+if [ "${diet}" = yes ]; then
+    if [ -e "${output_image}" ]; then
+        rm "${output_image}" || exit 1
+    fi
+    "${xorriso}" -report_about HINT -as mkisofs -graft-points -no-pad ${grub_mkisofs_arguments} --protective-msdos-label -r "${iso9660_dir}" --sort-weight 0 / --sort-weight 1 /boot ${source} | cat >"${output_image}"
+else
+    "${xorriso}" -report_about HINT -as mkisofs -graft-points ${grub_mkisofs_arguments} --protective-msdos-label -o "${output_image}" -r "${iso9660_dir}" --sort-weight 0 / --sort-weight 1 /boot ${source}
+fi
 rm -rf "${iso9660_dir}"
 
 rm -f "${sysarea_img}"
